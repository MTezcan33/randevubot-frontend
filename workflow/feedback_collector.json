{
  "name": "RandevuBot ‚Äî Geri Bildirim Toplayƒ±cƒ±",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [{ "field": "minutes", "minutesInterval": 30 }]
        }
      },
      "name": "30 Dakikada Bir",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT a.id, a.date, a.time, a.company_id, a.customer_id, c.name as customer_name, c.phone as customer_phone, co.name as salon_name FROM appointments a JOIN customers c ON c.id = a.customer_id JOIN companies co ON co.id = a.company_id WHERE a.status = 'onaylandƒ±' AND co.service_active = true AND (a.date || ' ' || a.time)::timestamp BETWEEN NOW() - INTERVAL '3 hours' AND NOW() - INTERVAL '1 hour 50 minutes' AND NOT EXISTS (SELECT 1 FROM customer_feedback cf WHERE cf.appointment_id = a.id) LIMIT 50"
      },
      "name": "Geri Bildirim Bekleyen Randevular",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [450, 300],
      "credentials": { "postgres": { "id": "supabase_pg", "name": "Supabase PostgreSQL" } }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.EVOLUTION_API_URL }}/message/sendText/{{ $json.salon_name }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $json.customer_phone }}"
            },
            {
              "name": "text",
              "value": "=Merhaba {{ $json.customer_name }}! üòä\n{{ $json.salon_name }}'daki deneyiminizi nasƒ±l deƒüerlendirirsiniz?\n\n1Ô∏è‚É£ - √áok K√∂t√º\n2Ô∏è‚É£ - K√∂t√º\n3Ô∏è‚É£ - Orta\n4Ô∏è‚É£ - ƒ∞yi\n5Ô∏è‚É£ - M√ºkemmel\n\nSadece rakamƒ± yazmanƒ±z yeterli."
            }
          ]
        }
      },
      "name": "Anket WhatsApp G√∂nder",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [700, 300]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "feedback-response",
        "responseMode": "onReceived",
        "responseData": "firstEntryJson"
      },
      "name": "M√º≈üteri Yanƒ±tƒ± Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 600],
      "webhookId": "feedback-response"
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ parseInt($json.body.message) }}",
              "operation": "largerEqual",
              "value2": 1
            },
            {
              "value1": "={{ parseInt($json.body.message) }}",
              "operation": "smallerEqual",
              "value2": 5
            }
          ]
        }
      },
      "name": "Ge√ßerli Puan mƒ±?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [450, 600]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "customer_feedback",
        "columns": "company_id,customer_id,appointment_id,rating,comment,status",
        "additionalFields": {}
      },
      "name": "Geri Bildirimi Kaydet",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [700, 600],
      "credentials": { "postgres": { "id": "supabase_pg", "name": "Supabase PostgreSQL" } }
    }
  ],
  "connections": {
    "30 Dakikada Bir": {
      "main": [[{ "node": "Geri Bildirim Bekleyen Randevular", "type": "main", "index": 0 }]]
    },
    "Geri Bildirim Bekleyen Randevular": {
      "main": [[{ "node": "Anket WhatsApp G√∂nder", "type": "main", "index": 0 }]]
    },
    "M√º≈üteri Yanƒ±tƒ± Webhook": {
      "main": [[{ "node": "Ge√ßerli Puan mƒ±?", "type": "main", "index": 0 }]]
    },
    "Ge√ßerli Puan mƒ±?": {
      "main": [[{ "node": "Geri Bildirimi Kaydet", "type": "main", "index": 0 }]]
    }
  },
  "settings": { "executionOrder": "v1" }
}
